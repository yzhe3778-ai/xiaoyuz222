# 落地实施规范

> 补充指南与实际 .agent 结构的完整对应、闭环流程、自动化配置

---

## 1. 规则文件完整引用矩阵

### 1.1 文件清单与引用级别

| 文件                      | 类型 | 引用级别 | 说明             |
| ------------------------- | ---- | -------- | ---------------- |
| `.current-stage`          | 配置 | 必读     | 当前阶段标识     |
| `CHANGELOG.md`            | 日志 | 必更新   | 规则变更必须记录 |
| `00-project-overview.md`  | 索引 | 必读     | 项目规则入口     |
| `01-frontend.md`          | 领域 | 按需     | 前端项目必读     |
| `02-backend.md`           | 领域 | 按需     | 后端项目必读     |
| `03-shared.md`            | 共享 | 推荐     | 类型/工具复用    |
| `04-documentation.md`     | 领域 | 按需     | 文档项目必读     |
| `stages/*.md`             | 阶段 | 必读     | 当前阶段规则     |
| `feedback/rule-issues.md` | 反馈 | 必更新   | 问题记录         |

### 1.2 按项目类型的引用组合

**代码项目（前后端）：**

```
必须引用：
  - .current-stage
  - 00-project-overview.md
  - stages/{当前阶段}.md
  - 01-frontend.md 或 02-backend.md

推荐引用：
  - 03-shared.md

可选引用：
  - 04-documentation.md
```

**文档项目：**

```
必须引用：
  - .current-stage
  - 00-project-overview.md
  - stages/{当前阶段}.md
  - 04-documentation.md

不需引用：
  - 01-frontend.md
  - 02-backend.md
```

### 1.3 标准引用模板

```
# 代码项目对话开头
当前阶段：@.agent/.current-stage
项目概览：@.agent/rules/00-project-overview.md
阶段规则：@.agent/rules/stages/development.md
领域规则：@.agent/rules/01-frontend.md
共享规则：@.agent/rules/03-shared.md

# 文档项目对话开头
当前阶段：@.agent/.current-stage
项目概览：@.agent/rules/00-project-overview.md
阶段规则：@.agent/rules/stages/development.md
文档规则：@.agent/rules/04-documentation.md
```

---

## 2. 反馈闭环流程

### 2.1 评审节奏

| 评审类型 | 频率   | 参与者 | 产出                    |
| -------- | ------ | ------ | ----------------------- |
| 快速记录 | 随时   | 个人   | rule-issues.md 新增条目 |
| 周评审   | 每周五 | 团队   | 问题标记优先级          |
| 月评审   | 每月末 | 团队   | 规则调整决策            |
| 季度评审 | 季度末 | 全员   | 规则版本升级            |

### 2.2 问题处理流程

```
1. 记录问题
   -> 在 rule-issues.md 添加条目
   -> 状态设为"待评审"

2. 评审讨论
   -> 周/月会议讨论
   -> 决定：采纳 / 拒绝 / 延后

3. 采纳执行（如果采纳）
   -> 修改对应规则文件
   -> 更新 CHANGELOG.md（新增版本条目）
   -> 将 rule-issues.md 中状态改为"已采纳"
   -> 关联 CHANGELOG 版本号

4. 通知同步
   -> 团队公告
   -> 更新自动化配置（如需）
```

### 2.3 rule-issues.md 与 CHANGELOG.md 联动格式

**rule-issues.md 条目格式：**

```markdown
### 问题 #002

- 日期：2026-01-28
- 规则：01-frontend.md:test-coverage
- 问题：覆盖率70%太高
- 建议：降为60%
- 状态：已采纳
- 关联版本：v1.1.0
```

**CHANGELOG.md 对应条目：**

```markdown
## [1.1.0] - 2026-01-30

### 修改

- 01-frontend.md: 测试覆盖率 70% -> 60%（#002）
```

---

## 3. 阶段切换检查清单

### 3.1 切换前检查

```
[ ] 当前阶段目标是否达成
[ ] 技术债务是否处理完毕
[ ] 团队是否准备好接受新阶段要求
```

### 3.2 切换时必做清单

```
1. 更新阶段标识
   [ ] 编辑 .agent/.current-stage
   [ ] 值改为：PROTOTYPE / DEVELOPMENT / TESTING / PRODUCTION

2. 检查阶段规则
   [ ] 查看对应 stages/{阶段}.md
   [ ] 确认阈值是否需要调整
   [ ] 如需调整，更新文件并记录 CHANGELOG

3. 同步自动化配置
   [ ] 更新 .eslintrc.js（如严格程度变化）
   [ ] 更新 jest.config.js（如覆盖率阈值变化）
   [ ] 更新 .husky/pre-commit（如检查项变化）
   [ ] 更新 CI/CD 配置（如门槛变化）

4. 记录变更
   [ ] 在 CHANGELOG.md 记录阶段切换

5. 团队通知
   [ ] 公告新阶段规则
   [ ] 说明新的检查标准
```

### 3.3 阶段切换示例

```bash
# 从开发阶段切换到测试阶段

# 1. 更新阶段标识
echo "TESTING" > .agent/.current-stage

# 2. 更新覆盖率阈值（jest.config.js）
#    coverageThreshold: { global: { lines: 80 } }  # 从70改为80

# 3. 更新CI配置
#    添加 E2E 测试、安全扫描

# 4. 记录 CHANGELOG
#    ## [1.2.0] - 2026-02-01
#    ### 变更
#    - 阶段切换：DEVELOPMENT -> TESTING
#    - 覆盖率阈值：70% -> 80%
```

---

## 4. 规则冲突与优先级

### 4.1 优先级层级

```
优先级从高到低：

1. 阶段规则（stages/*.md）
   └─ 当前阶段的要求最优先

2. 领域规则（01-frontend.md / 02-backend.md）
   └─ 特定领域的专业规则

3. 共享规则（03-shared.md）
   └─ 通用规则

4. 项目概览（00-project-overview.md）
   └─ 基础框架
```

### 4.2 冲突处理规则

**冲突示例：**

- `01-frontend.md` 要求覆盖率 >= 70%
- `stages/testing.md` 要求覆盖率 >= 80%

**处理方式：**

```
阶段规则 > 领域规则

因此：测试阶段使用 80%，开发阶段使用 70%
```

### 4.3 冲突记录

如发现规则冲突，必须：

1. 在 `rule-issues.md` 记录
2. 评审时决定统一标准
3. 更新规则文件，消除歧义

---

## 5. 按项目类型剪裁

### 5.1 代码项目（前后端）

**工具链：**

```
代码检查：ESLint + Prettier
类型检查：TypeScript
测试框架：Jest + React Testing Library
提交检查：Husky + lint-staged + commitlint
CI/CD：GitHub Actions
```

**最小配置：**

```bash
npm install -D eslint prettier typescript jest husky lint-staged @commitlint/cli
```

### 5.2 文档项目（本项目类型）

**工具链：**

```
Markdown检查：markdownlint
拼写检查：cspell
链接检查：markdown-link-check
格式化：Prettier
提交检查：Husky + commitlint
```

**最小配置：**

```bash
npm install -D markdownlint-cli cspell prettier husky @commitlint/cli
```

**package.json 示例：**

```json
{
  "scripts": {
    "lint:md": "markdownlint '**/*.md' --ignore node_modules",
    "lint:spell": "cspell '**/*.md'",
    "lint:links": "markdown-link-check '**/*.md'",
    "format": "prettier --write '**/*.md'"
  },
  "lint-staged": {
    "*.md": ["markdownlint --fix", "prettier --write"]
  }
}
```

**.markdownlint.json：**

```json
{
  "default": true,
  "MD013": false,
  "MD033": false,
  "MD041": false
}
```

**cspell.json：**

```json
{
  "version": "0.2",
  "language": "en,zh",
  "words": ["GLM", "TypeScript", "ESLint", "Husky"],
  "ignorePaths": ["node_modules"]
}
```

---

## 6. 最小可运行自动化配置

### 6.1 Husky Pre-commit

**.husky/pre-commit：**

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "Running pre-commit checks..."

# 代码项目
# npx lint-staged
# npm run type-check

# 文档项目
npx lint-staged
npm run lint:spell -- --no-must-find-files

echo "Pre-commit checks passed!"
```

### 6.2 lint-staged

**.lintstagedrc.js：**

```javascript
module.exports = {
  // 代码项目
  // '*.{ts,tsx}': ['eslint --fix', 'prettier --write'],

  // 文档项目
  '*.md': ['markdownlint --fix', 'prettier --write'],
  '*.{json,yml}': ['prettier --write'],
};
```

### 6.3 commitlint

**commitlint.config.js：**

```javascript
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      ['feat', 'fix', 'docs', 'style', 'refactor', 'perf', 'test', 'chore'],
    ],
    'subject-case': [0], // 允许中文
  },
};
```

### 6.4 GitHub Actions CI

**.github/workflows/ci.yml：**

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      # 文档项目
      - name: Markdown Lint
        run: npm run lint:md

      - name: Spell Check
        run: npm run lint:spell

      # 代码项目取消注释
      # - name: ESLint
      #   run: npm run lint
      # - name: TypeScript
      #   run: npm run type-check
      # - name: Test
      #   run: npm run test:ci

  # 测试阶段额外检查
  security:
    if: github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm audit --audit-level=high
```

### 6.5 性能/安全工具（测试阶段）

**性能测试（Lighthouse）：**

```bash
npm install -D @lhci/cli

# package.json
"scripts": {
  "lighthouse": "lhci autorun"
}

# lighthouserc.js
module.exports = {
  ci: {
    collect: { url: ['http://localhost:3000'] },
    assert: {
      preset: 'lighthouse:recommended',
      assertions: {
        'first-contentful-paint': ['warn', { maxNumericValue: 3000 }],
        'largest-contentful-paint': ['error', { maxNumericValue: 4000 }],
      },
    },
  },
};
```

**安全扫描：**

```bash
# 依赖漏洞
npm audit --audit-level=high

# 代码安全（可选）
npx eslint-plugin-security
```

---

## 7. 权限管理与本地配置

### 7.1 配置文件层级

```
全局配置（所有项目）：
  ~/.claude/settings.json

项目配置（当前项目）：
  .claude/settings.local.json

规则配置（本项目）：
  .agent/rules/
```

### 7.2 权限白名单管理

**settings.local.json 结构：**

```json
{
  "permissions": {
    "allow": ["Skill(allowed-skill-name)"],
    "deny": []
  }
}
```

**管理规则：**

1. 白名单变更需要团队审批
2. 每个权限需要说明用途
3. 定期审计已授权权限

### 7.3 配置文件入库策略

| 文件                          | 是否入库 | 说明                     |
| ----------------------------- | -------- | ------------------------ |
| `.agent/`                     | 是       | 规则是团队共享的         |
| `.claude/settings.local.json` | 视情况   | 如果包含敏感信息则不入库 |
| `~/.claude/settings.json`     | 否       | 个人配置                 |

### 7.4 审计清单

每季度检查：

```
[ ] 权限白名单是否有冗余
[ ] 是否有未使用的 Skill
[ ] 权限是否与项目需求匹配
[ ] 是否有安全风险
```

---

## 8. 度量指标体系

### 8.1 代码质量指标

| 指标       | 计算方式            | 阈值      | 评审周期 |
| ---------- | ------------------- | --------- | -------- |
| 测试覆盖率 | Jest coverage       | >=70%/80% | 每次提交 |
| 缺陷率     | Bugs / KLOC         | < 5       | 每月     |
| 技术债务   | TODO 数量           | 趋势下降  | 每周     |
| 回滚率     | 回滚次数 / 发布次数 | < 5%      | 每月     |

### 8.2 AI 协作指标

| 指标        | 计算方式             | 阈值   | 评审周期 |
| ----------- | -------------------- | ------ | -------- |
| AI 生成占比 | AI 代码行 / 总代码行 | 参考值 | 每月     |
| 规则遵循率  | 检查通过 / 总提交    | >= 90% | 每周     |
| 规则采纳率  | 采纳问题 / 提出问题  | >= 50% | 每月     |
| 反馈周期    | 问题提出到解决的天数 | < 14天 | 每月     |

### 8.3 度量面板模板

**文件：.agent/metrics/monthly-report.md**

```markdown
# 2026-01 度量报告

## 代码质量

- 测试覆盖率：75%
- 新增缺陷：3
- 技术债务 TODO：12（上月：15）

## AI 协作

- Pre-commit 通过率：92%
- 规则问题提出：5
- 规则问题采纳：3
- 平均反馈周期：7 天

## 趋势分析

- 覆盖率：稳定
- 技术债务：下降趋势
- 规则遵循率：上升趋势

## 下月目标

- 覆盖率提升到 80%
- 技术债务降到 10 以下
```

---

## 9. 纯文本兼容版本

### 9.1 无 emoji 替代

| 原版 | 纯文本版 |
| ---- | -------- |
| ✅   | [OK]     |
| ❌   | [NO]     |
| ⚠️   | [WARN]   |
| 🟢   | [HIGH]   |
| 🟡   | [MED]    |
| 🔴   | [LOW]    |

### 9.2 终端显示建议

```powershell
# PowerShell 设置 UTF-8
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8

# 或在 profile 中永久设置
Add-Content $PROFILE '[Console]::OutputEncoding = [System.Text.Encoding]::UTF8'
```

---

## 10. 检查清单总表

### 项目初始化检查

```
[ ] 创建 .agent 目录结构
[ ] 设置 .current-stage
[ ] 创建所有规则文件
[ ] 配置自动化工具（按项目类型）
[ ] 初始化 CHANGELOG.md
[ ] 团队同步规则
```

### 日常开发检查

```
[ ] 对话前引用正确的规则文件
[ ] 提交前 pre-commit 通过
[ ] 问题及时记录到 rule-issues.md
```

### 阶段切换检查

```
[ ] 更新 .current-stage
[ ] 调整自动化阈值
[ ] 更新 CI 配置
[ ] 记录 CHANGELOG
[ ] 通知团队
```

### 定期评审检查

```
[ ] 周：问题记录、优先级标记
[ ] 月：规则调整、度量报告
[ ] 季：版本升级、权限审计
```

---

_最后更新：2026-01-28_
_版本：1.0.5_
